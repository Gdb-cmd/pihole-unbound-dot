version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: gdb-redis-cache
    restart: unless-stopped
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 900 1 --save 300 10 --save 60 10000
    volumes:
      - redis-data:/data
    networks:
      gdb-dns-net:
        ipv4_address: 172.21.0.10
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  unbound:
    build: .
    container_name: gdb-unbound-dot
    restart: unless-stopped
    volumes:
      - unbound-data:/var/lib/unbound
    networks:
      gdb-dns-net:
        ipv4_address: 172.21.0.20
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "drill", "@127.0.0.1", "cloudflare.com"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

  pihole:
    image: pihole/pihole:latest
    container_name: gdb-pihole
    restart: unless-stopped
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "80:80/tcp"
      - "443:443/tcp"
    environment:
      TZ: 'Europe/Dublin'
      WEBPASSWORD: 'YourSecurePassword123!'
      PIHOLE_DNS_1: '172.21.0.20#53'
      PIHOLE_DNS_2: '172.21.0.20#53'
      DNS_FQDN_REQUIRED: 'true'
      DNS_BOGUS_PRIV: 'true'
      DNSSEC: 'false'
      CONDITIONAL_FORWARDING: 'false'
      DNSMASQ_LISTENING: 'all'
      INTERFACE: 'eth0'
      BLOCKING_ENABLED: 'true'
      QUERY_LOGGING: 'true'
      INSTALL_WEB_SERVER: 'true'
      INSTALL_WEB_INTERFACE: 'true'
      LIGHTTPD_ENABLED: 'true'
      CACHE_SIZE: '5000'
    volumes:
      - pihole-config:/etc/pihole
      - pihole-dnsmasq:/etc/dnsmasq.d
    networks:
      gdb-dns-net:
        ipv4_address: 172.21.0.30
    depends_on:
      unbound:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
      - SYS_NICE
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
      - /var/log
    dns:
      - 127.0.0.1
      - 172.21.0.20

volumes:
  redis-data:
  unbound-data:
  pihole-config:
  pihole-dnsmasq:

networks:
  gdb-dns-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1
